{% extends 'base.html' %}
{% load static %}

{% block title %}Chat avec {{ other_user.username }} - TAWSILA24{% endblock %}

{% block extra_css %}
<style>
    .chat-container {
        height: calc(100vh - 200px);
        display: flex;
        flex-direction: column;
        background: white;
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        overflow: hidden;
    }

    .chat-header {
        padding: 1rem 1.5rem;
        background: #f8f9fa;
        border-bottom: 1px solid #eee;
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
        background: #fdfdfd;
    }

    .message-bubble {
        max-width: 70%;
        padding: 0.8rem 1.2rem;
        border-radius: 18px;
        position: relative;
        font-size: 0.95rem;
    }

    .message-sent {
        align-self: flex-end;
        background: #00aff5;
        color: white;
        border-bottom-right-radius: 4px;
    }

    .message-received {
        align-self: flex-start;
        background: #f1f1f1;
        color: #333;
        border-bottom-left-radius: 4px;
    }

    .message-info {
        font-size: 0.75rem;
        margin-top: 0.3rem;
        opacity: 0.8;
    }

    .chat-input-area {
        padding: 1rem 1.5rem;
        background: white;
        border-top: 1px solid #eee;
    }

    .chat-form {
        display: flex;
        gap: 0.8rem;
    }

    .chat-input {
        flex: 1;
        border-radius: 24px;
        border: 1px solid #ddd;
        padding: 0.6rem 1.2rem;
        outline: none;
    }

    .chat-input:focus {
        border-color: #00aff5;
    }

    .send-btn {
        width: 42px;
        height: 42px;
        border-radius: 50%;
        background: #00aff5;
        color: white;
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: transform 0.2s;
    }

    .send-btn:hover {
        transform: scale(1.05);
        background: #0099d6;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="mb-3">
        <a href="{% url 'inbox' %}" class="btn btn-link text-decoration-none">
            <i class="bi bi-arrow-left me-2"></i>Retour aux messages
        </a>
    </div>

    <div class="chat-container">
        <div class="chat-header">
            {% if other_user.profile_picture %}
            <img src="{{ other_user.profile_picture.url }}" class="rounded-circle" width="40" height="40"
                style="object-fit: cover;">
            {% else %}
            <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center"
                style="width: 40px; height: 40px;">
                <i class="bi bi-person"></i>
            </div>
            {% endif %}
            <div>
                <h6 class="mb-0">{{ other_user.get_full_name|default:other_user.username }}</h6>
                <small class="text-success">En ligne</small>
            </div>
        </div>

        <div id="chat-messages" class="chat-messages">
            {% for msg in messages_list %}
            <div
                class="message-bubble {% if msg.sender == request.user %}message-sent{% else %}message-received{% endif %}">
                <div class="message-content">{{ msg.body }}</div>
                <div class="message-info">{{ msg.created_at|date:"H:i" }}</div>
            </div>
            {% endfor %}
        </div>

        <div class="chat-input-area">
            <form id="chat-form" class="chat-form">
                <input type="text" id="chat-input" class="chat-input" placeholder="Ã‰crivez votre message..."
                    autocomplete="off">
                <button type="submit" class="send-btn">
                    <i class="bi bi-send-fill"></i>
                </button>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const otherUserId = "{{ other_user.id }}";
    const currentUserId = "{{ request.user.id }}";
    const chatMessages = document.getElementById('chat-messages');
    const chatForm = document.getElementById('chat-form');
    const chatInput = document.getElementById('chat-input');

    // Scroll to bottom
    const scrollToBottom = () => {
        chatMessages.scrollTop = chatMessages.scrollHeight;
    };
    scrollToBottom();

    // WebSocket Connection
    const chatSocket = new WebSocket(
        (window.location.protocol === 'https:' ? 'wss://' : 'ws://') +
        window.location.host +
        '/ws/chat/' + otherUserId + '/'
    );

    chatSocket.onmessage = function (e) {
        const data = json.loads ? JSON.parse(e.data) : JSON.parse(e.data);
        const isMe = data.sender_id == currentUserId;

        const messageHtml = `
            <div class="message-bubble ${isMe ? 'message-sent' : 'message-received'}">
                <div class="message-content">${data.message}</div>
                <div class="message-info">${data.timestamp}</div>
            </div>
        `;

        chatMessages.insertAdjacentHTML('beforeend', messageHtml);
        scrollToBottom();
    };

    chatSocket.onclose = function (e) {
        console.error('Chat socket closed unexpectedly');
    };

    chatForm.onsubmit = function (e) {
        e.preventDefault();
        const message = chatInput.value.trim();
        if (message) {
            chatSocket.send(JSON.stringify({
                'message': message
            }));
            chatInput.value = '';
        }
    };
</script>
{% endblock %}